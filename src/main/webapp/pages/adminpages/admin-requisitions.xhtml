<ui:composition template="temp.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core">
    <ui:define name="title">Requisitions</ui:define>
    <ui:define name="main-content">
        <h2>Requisitions</h2>
        <h4>Statistics</h4>
        <div class="stats">
            <h:form id="statsForm">
                <p:panelGrid columns="3" styleClass="stats-grid">
                    <p:panel header="Pending" styleClass="stat-panel">
                        <h:outputText value="#{allRequisitions.pendingRequisitions.size()}" styleClass="stat-value"/>
                    </p:panel>
                    <p:panel header="Approved" styleClass="stat-panel">
                        <h:outputText value="#{allRequisitions.approvedRequisitions.size()}" styleClass="stat-value"/>
                    </p:panel>
                    <p:panel header="Rejected" styleClass="stat-panel">
                        <h:outputText value="#{allRequisitions.rejectedRequisitions.size()}" styleClass="stat-value"/>
                    </p:panel>
                </p:panelGrid>
            </h:form>

        </div>

        <!-- Tabbed Section -->
        <h:form id="tabForm">
            <p:tabView id="tabView" activeIndex="#{allRequisitions.activeTab}">
                <p:ajax event="tabChange" listener="#{allRequisitions.onTabChange}" update=":requisitions_table_form:requisition_table"/>
                <p:tab id="pendingTab" title="Pending"/>
                <p:tab id="approvedTab" title="Approved"/>
                <p:tab id="rejectedTab" title="Rejected"/>
                <p:tab id="paid" title="Paid"/>
            </p:tabView>
        </h:form>


        <div class="actions">
            <h:form id="action_buttons_button">
                <p:commandButton value="Add New" onclick="PF('new_requisition_dialog').show()" update="new_requisition_form" icon="pi pi-plus" styleClass="mr"/>
                <p:commandButton value="Delete All" onclick="PF('confirmDeleteAllBasedOnStatusDialog').show()" icon="pi pi-trash" styleClass="bg-r"/>
            </h:form>
        </div>

        <h:form id="requisitions_table_form">
            <p:dataTable id="requisition_table" value="#{allRequisitions.requisitionsForActiveTab}" var="requisition" paginator="true" rows="5">
                <p:column headerText="No">
                    <h:outputText value="#{allRequisitions.requisitionsForActiveTab.indexOf(requisition) + 1}"/>
                </p:column>
                <p:column headerText="Amount requested">
                    <h:outputText value="#{requisition.estimatedAmount}"/>
                </p:column>
                <p:column headerText="Amount granted">
                    <h:outputText value="#{requisition.amountGranted}"/>
                </p:column>
                <p:column headerText="Edit Status" rendered="#{requisition.status.equals('Pending')}">
                    <p:commandButton icon="pi pi-pencil" action="#{updateRequisition.selectRequisition(requisition)}" onclick="PF('modify_status_dialog').show()" update="modify_status_form" />
                </p:column>
                <p:column headerText="Actions" rendered="#{requisition.status.equals('Pending')}">
                    <p:commandButton value="Delete" onclick="PF('confirmDeleteDialog').show()" action="#{deleteRequisition.selectSpecificRequisition(requisition)}" icon="pi pi-times" styleClass="bg-r" rendered="#{checkPermission.hasPermission('DELETE_REQUISITION')}"/>
                    <p:commandButton value="Edit" icon="pi pi-pencil" action="#{updateRequisition.selectRequisition(requisition)}" onclick="PF('edit_requisition_dialog').show()" update="edit_requisition_form" styleClass="bg-g" rendered="#{checkPermission.hasPermission('EDIT_REQUISITION')}"/>
                </p:column>
                <p:column headerText="Creation Date">
                    <h:outputText value="#{requisition.dateCreated}"/>
                </p:column>
                <p:column headerText="Needed By">
                    <h:outputText value="#{requisition.maxDateNeeded}"/>
                </p:column>

                <p:column headerText="Review" rendered="#{requisition.status.equals('Approved') || requisition.status.equals('Rejected') || requisition.status.equals('Paid')}">
                    <h:outputText value="#{requisition.review_comments}"/>
                </p:column>

                <p:column headerText="Transact" rendered="#{checkPermission.hasPermission('CASHOUT_REQUISITION') and requisition.status.equals('Approved')}">
                    <p:commandButton action="#{disburseCash.selectRequisition(requisition)}" value="Disburse Money" onclick="PF('disburse_money_dialog').show()"/>
                </p:column>

                <p:column headerText="Approval Date" rendered="#{requisition.status.equals('Approved')}">
                    <h:outputText value="#{requisition.dateApproved}"/>
                </p:column>

            </p:dataTable>
        </h:form>


        <p:dialog widgetVar="new_requisition_dialog" header="Create New Budgetline" modal="true">
            <h:form id="new_requisition_form">
                <p:panelGrid columns="2" styleClass="requisition-grid">
                    <p:outputLabel for="amount_requested" value="Amount Requested:"/>
                    <p:inputText id="amount_requested" value="#{createRequisition.requestedAmount}" required="true" autocomplete="false"/>

                    <p:outputLabel for="date_needed" value="Date Needed:"/>
                    <p:calendar id="date_needed" value="#{createRequisition.maxDate}" required="true" mindate="#{createBudgetLine.today}" showButtonPanel="true" />

                    <p:outputLabel for="justification" value="Justification:"/>
                    <p:inputText id="justification" value="#{createRequisition.justification}" required="true" />

                    <p:outputLabel for="budgetLine" value="Budgetline:"/>
                    <p:selectOneMenu id="budgetLine" value="#{createRequisition.budgetLineId}">
                        <f:selectItem itemValue="" itemLabel="Select Budgetline"/>
                        <f:selectItems value="#{createRequisition.budgetLines}" var="budgetline" itemValue="#{budgetline.id}" itemLabel="#{budgetline.description}"/>
                    </p:selectOneMenu>

                    <p:commandButton value="Save" actionListener="#{createRequisition.createRequisition}"
                                     onclick="PF('new_requisition_dialog').hide()" update="statsForm, :tabForm:tabView, :requisitions_table_form:requisition_table, :new_requisition_form"/>
                    <p:commandButton value="Cancel" onclick="PF('new_requisition_dialog').hide()"/>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog id="edit_requisition_dialog" widgetVar="edit_requisition_dialog" header="Edit Budgetline" modal="true">
            <h:form id="edit_requisition_form">
                <p:panelGrid columns="2" styleClass="requisition-grid">
                    <p:outputLabel for="edit_amount_requested" value="Amount Requested:"/>
                    <p:inputText id="edit_amount_requested" value="#{updateRequisition.requestedAmount}" required="true" autocomplete="false"/>

                    <p:outputLabel for="edit_date_needed" value="Date Needed:"/>
                    <p:calendar id="edit_date_needed" value="#{updateRequisition.maxDate}" required="true" mindate="#{createBudgetLine.today}" showButtonPanel="true" />

                    <p:outputLabel for="edit_justification" value="Justification:"/>
                    <p:inputText id="edit_justification" value="#{updateRequisition.justification}" required="true" />

                    <p:outputLabel for="edit_requisition" value="Budgetline:"/>
                    <p:selectOneMenu id="edit_requisition" value="#{updateRequisition.budgetLineId}">
                        <f:selectItem itemValue="" itemLabel="Select BudgetLine"/>
                        <f:selectItems value="#{updateRequisition.budgetLines}" var="budgetline" itemLabel="#{budgetline.description}" itemValue="#{budgetline.id}" />
                    </p:selectOneMenu>

                    <p:commandButton value="Save" actionListener="#{updateRequisition.updateRequisition}"
                                     onclick="PF('edit_requisition_dialog').hide()" update="statsForm, :tabForm:tabView, :requisitions_table_form:requisition_table, :new_requisition_form"/>
                    <p:commandButton value="Cancel" onclick="PF('edit_requisition_dialog').hide()"/>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <p:confirmDialog widgetVar="confirmDeleteDialog" id="confirmDialog" message="Delete Budgetline?"
                         header="Confirm" icon="pi pi-exclamation-triangle">
            <p:commandButton value="Yes" oncomplete="PF('confirmDeleteDialog').hide()"
                             actionListener="#{deleteRequisition.deleteSpecificRequisition}"
                             update="statsForm, :requisitions_table_form:requisition_table, :new_requisition_form" />
            <p:commandButton value="No" onclick="PF('confirmDeleteDialog').hide()" type="button" />
        </p:confirmDialog>



        <p:confirmDialog widgetVar="disburse_money_dialog" id="disburse_money_dialog" message="Transfer funds from Budgetline Acoount?"
                         header="Disburse" icon="pi pi-exclamation-triangle">

            <p:commandButton value="Transact" oncomplete="PF('disburse_money_dialog').hide()"
                             actionListener="#{disburseCash.disburseCash}"
                             update="statsForm, :requisitions_table_form:requisition_table, :new_requisition_form" />
            <p:commandButton value="No" onclick="PF('disburse_money_dialog').hide()" type="button" />
        </p:confirmDialog>



        <p:confirmDialog widgetVar="confirmDeleteAllBasedOnStatusDialog" id="confirmDeleteAllBasedOnStatusDialog" message="Delete Budgetlines?"
                         header="Confirm" icon="pi pi-exclamation-triangle">
            <p:commandButton value="Yes" oncomplete="PF('confirmDeleteAllBasedOnStatusDialog').hide()"
                             actionListener="#{deleteRequisition.deleteAllRequisitionsOfStatus}"
                             update="statsForm, :tabForm:tabView, :requisitions_table_form:requisition_table, :new_requisition_form"/>
            <p:commandButton value="No" onclick="PF('confirmDeleteAllBasedOnStatusDialog').hide()" type="button" />
        </p:confirmDialog>

        <p:dialog widgetVar="modify_status_dialog" header="Modify status" modal="true">
            <h:form id="modify_status_form">
                <p:panelGrid columns="2" styleClass="requisition-grid">
                    <p:outputLabel for="status" value="Status:"/>
                    <p:selectOneMenu id="status" value="#{updateRequisition.status}">
                        <f:selectItem itemLabel="Reject" itemValue="Rejected"/>
                        <f:selectItem itemLabel="Approve" itemValue="Approved"/>
                        <f:selectItem itemLabel="Request changes" itemValue="RequestEdit"/>
                    </p:selectOneMenu>

                    <p:outputLabel value="Comment" for="comment"/>
                    <p:inputTextarea id="comment" value="#{updateRequisition.reviewComments}" />

                    <p:outputLabel type="number" for="granted_amount" value="Granted Amount"/>
                    <p:inputNumber id="granted_amount" value="#{updateRequisition.amountGranted}" />

                    <p:commandButton value="Modify" actionListener="#{updateRequisition.updateRequisition}"
                                     onclick="PF('modify_status_dialog').hide()" update="statsForm, :tabForm:tabView, :requisitions_table_form:requisition_table, :new_requisition_form"/>
                    <p:commandButton value="Cancel" onclick="PF('modify_status_dialog').hide()"/>
                </p:panelGrid>
            </h:form>
        </p:dialog>

    </ui:define>


</ui:composition>