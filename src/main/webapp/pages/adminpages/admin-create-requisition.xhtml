<ui:composition template="temp.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core">
    <f:event type="preRenderView" listener="#{myRequisitionHandler.selectRequisition}"/>
    <ui:define name="title">My Requisitions</ui:define>
    <ui:define name="main-content">
        <p:tabView id="bigTab">
            <p:tab title="Current">
                <h:form id="requisition_form" styleClass="pad2 mb flex column">
                <h2 class="mb">#{myRequisitionHandler.status.equals("")?'Create':myRequisitionHandler.status} Requisition</h2>
                    <p:panelGrid columns="2" layout="tabular">
                        <h:panelGroup class="flex column">
                            <p:outputLabel for="budgetline" value="Budget Line"/>
                            <p:selectOneMenu id="budgetline" value="#{myRequisitionHandler.budgetLineId}" disabled="#{not (myRequisitionHandler.status.equals('Draft') or myRequisitionHandler.status.equals('Pending'))}">
                                <f:selectItem value="#{null}" itemDisabled="true" itemLabel="Choose Budgetline" />
                                <f:selectItems value="#{myRequisitionHandler.budgetLines}" var="budgetline" itemValue="#{budgetline.id}" itemLabel="#{budgetline.description}"/>
                            </p:selectOneMenu>
                        </h:panelGroup>
                        <h:panelGroup class="flex column">
                            <p:outputLabel for="status" value="Status"/>
                            <p:inputText id="status" placeholder="Status" readonly="true" value="#{myRequisitionHandler.status}"/>
                        </h:panelGroup>
                        <h:panelGroup class="flex column">
                            <p:outputLabel for="amount" value="Amount"/>
                            <p:inputNumber styleClass="fillW" id="amount" value="#{myRequisitionHandler.requestedAmount}" disabled="#{(createRequisition.budgetLine ne null) and not (myRequisitionHandler.status.equals('Draft') or myRequisitionHandler.status.equals('Pending'))}"/>
                        </h:panelGroup>
                        <h:panelGroup class="flex column">
                            <p:outputLabel for="date_needed" value="Date Needed"/>
                            <p:calendar navigator="true" styleClass="fillW" id="date_needed" mindate="c" placeholder="Date Needed" value="#{myRequisitionHandler.maxDate}" disabled="#{not (myRequisitionHandler.status.equals('Draft') or myRequisitionHandler.status.equals('Pending'))}"/>
                        </h:panelGroup>
                        <h:panelGroup class="flex column">
                            <p:outputLabel for="justification" value="Justification"/>
                            <p:inputTextarea id="justification" placeholder="Description..." value="#{myRequisitionHandler.justification}" disabled="#{not (myRequisitionHandler.status.equals('Draft') or myRequisitionHandler.status.equals('Pending'))}"/>
                        </h:panelGroup>
                        <h:panelGroup class="flex column" rendered="#{myRequisitionHandler.status.equals('Approved') or myRequisitionHandler.status.equals('Paid')}">
                            <p:outputLabel for="amountGranted" value="Amount Granted"/>
                            <p:outputLabel id="amountGranted" value="#{myRequisitionHandler.amountGranted}"/>
                        </h:panelGroup>
                    </p:panelGrid>
                    <div>
                        <h:outputText value="Your Requisition is currently in review. Please check back later."
                                      rendered="#{myRequisitionHandler.status.equals('Pending')}"/>
                        <h:outputText value="Your Requisition has been Approved. Please wait a small while for the money to reach you."
                                      rendered="#{myRequisitionHandler.status.equals('Approved')}"/>
                        <p:commandButton value="Submit" icon="pi pi-check" styleClass="mt pill" actionListener="#{myRequisitionHandler.updateRequisition}"
                                         update="globalMessages @form" rendered="#{myRequisitionHandler.status.equals('Draft') or myRequisitionHandler.status.equals(null) or myRequisitionHandler.status.length() lt 1}"/>

                        <p:commandButton value="Save Draft" icon="pi pi-check" styleClass="mt pill" actionListener="#{myRequisitionHandler.saveOrUpdateDraftRequisition}"
                                         update="globalMessages @form" rendered="#{myRequisitionHandler.status.equals('Draft') or myRequisitionHandler.status.equals(null) or myRequisitionHandler.status.length() lt 1}"/>
                        <p:messages globalOnly="true" id="globalMessages" closable="true"/>
                    </div>
                </h:form>
                <h:panelGroup id="accountability_section" rendered="#{myRequisitionHandler.status.equals('Paid')}" styleClass="mt pad2">
                    <f:event type="preRenderView" listener="#{createAccountability.initialiseAccountability}"/>

                    <h3 class="mb">Accountability</h3>
                    <h:form styleClass="flex column pad2">
                        <h:panelGroup styleClass="flex row pad1">
                            <h:panelGroup styleClass="flex column fillW">
                                <p:outputLabel for="ac_amt_used" value="Amount Used" styleClass="mt"/>
                                <p:inputNumber id="ac_amt_used" placeholder="Amount Used" styleClass="mb mt" value="#{createAccountability.amountSpent}" required="true"/>
                            </h:panelGroup>
                            <h:panelGroup styleClass="flex column fillW">
                                <p:outputLabel for="ac_description" value="Description" styleClass="mt"/>
                                <p:inputTextarea id="ac_description" placeholder="Description" styleClass="mb mt" value="#{createAccountability.description}"/>
                            </h:panelGroup>
                        </h:panelGroup>
                        <div>
                            <p:panel header="Upload Image">
                                <p:fileUpload listener="#{createAccountability.handleFileUpload}" mode="simple" dragDropSupport="true" auto="true" update="imagePreview messages" />

                                <p:graphicImage id="imagePreview" value="#{createAccountability.imageStream}" width="100" height="100"/>
                            </p:panel>
                        </div>

                        <div>
                            <p:commandButton value="Save Draft" update="messages bigTab" icon="pi pi-upload" action="#{createAccountability.saveOrUpdateAccountabilityDraft}" styleClass="mt pill"/>
                            <p:commandButton value="Submit Accountability" update="messages bigTab" icon="pi pi-upload" action="#{createAccountability.save}" styleClass="mt pill"/>
                            <p:messages globalOnly="true" id="messages" closable="true"/>
                        </div>
                    </h:form>
                </h:panelGroup>
            </p:tab>
            <p:tab title="History">
                <h:form id="history_form">
                    <p:tabView activeIndex="#{myRequisitions.activeTab}">
                        <p:ajax event="tabChange" listener="#{myRequisitions.onTabChange}" update="bigTab:history_form"/>
                        <p:tab id="completedTab" title="COMPLETED"/>
                        <p:tab id="rejectedTab" title="REJECTED"/>
                        <p:tab id="expiredTab" title="EXPIRED"/>
                    </p:tabView>
                    <div class="bg-white pad1">
                        <p:inputText styleClass="pill fillW" value="#{myRequisitions.searchTerm}" placeholder="Search">
                            <p:ajax event="keyup" update="my_requisition_table" listener="#{myRequisitions.filterRequisitionsForActiveTab}"/>
                        </p:inputText>
                    </div>
                    <p:dataTable rowIndexVar="index" id="my_requisition_table" paginator="true" rows="5" rowsPerPageTemplate="5,10,15" value="#{myRequisitions.requisitionsForActiveTab}" var="requisition">
                        <p:column headerText="No" width="16px">#{index + 1}</p:column>
                        <p:column headerText="Description">
                            #{requisition.justification}
                        </p:column>
                        <p:column headerText="Status">
                            #{requisition.status}
                        </p:column>
                        <p:column headerText="Requested">
                            #{requisition.estimatedAmount}
                        </p:column>
                        <p:column headerText="Granted">
                            #{requisition.amountGranted}
                        </p:column>
                        <p:column headerText="Budget Line">
                            #{requisition.budgetline.description}
                        </p:column>
                        <p:column headerText="Date Approved" rendered="#{requisition.status.equals('Approved')}">
                            #{requisition.dateApproved}
                        </p:column>
                    </p:dataTable>
                </h:form>
            </p:tab>
        </p:tabView>
    </ui:define>
</ui:composition>



